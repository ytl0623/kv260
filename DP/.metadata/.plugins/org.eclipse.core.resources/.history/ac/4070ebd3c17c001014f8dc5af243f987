#include <stdio.h>
#include "platform.h"
#include "xil_printf.h"
#include "xv_tpg.h"
#include "xvtc.h"
#include "xvidc.h"
#include "xdpdma_video_example.h" //change according to your file name

XV_tpg tpg;
XVtc vtc;
XVtc_Config *vtc_config;

void driverInit() {

	XV_tpg_Initialize(&tpg, 0);

	vtc_config = XVtc_LookupConfig(XPAR_VTC_0_DEVICE_ID);

	XVtc_CfgInitialize(&vtc, vtc_config, vtc_config->BaseAddress);

}
void ConfigVtc(XVidC_VideoStream *StreamPtr) {
	XVtc_Timing vtc_timing = { 0 };
	u16 PixelsPerClock = 1; // one pixel one clock

	vtc_timing.HActiveVideo = StreamPtr->Timing.HActive / PixelsPerClock; // 1920
	vtc_timing.HFrontPorch = StreamPtr->Timing.HFrontPorch / PixelsPerClock;
	vtc_timing.HSyncWidth = StreamPtr->Timing.HSyncWidth / PixelsPerClock;
	vtc_timing.HBackPorch = StreamPtr->Timing.HBackPorch / PixelsPerClock;
	vtc_timing.HSyncPolarity = StreamPtr->Timing.HSyncPolarity;
    print(vtc_timing.HActiveVideo, HActiveVideo.HFrontPorch, HFrontPorch.HSyncWidth, HSyncWidth.HBackPorch, HBackPorch.HSyncPolarity) ;
	vtc_timing.VActiveVideo = StreamPtr->Timing.VActive; // 1080
	vtc_timing.V0FrontPorch = StreamPtr->Timing.F0PVFrontPorch;
	vtc_timing.V0SyncWidth = StreamPtr->Timing.F0PVSyncWidth;
	vtc_timing.V0BackPorch = StreamPtr->Timing.F0PVBackPorch;
	vtc_timing.VSyncPolarity = StreamPtr->Timing.VSyncPolarity;
	print(vtc_timing.VActiveVideo, HActiveVideo.V0FrontPorch, HFrontPorch.V0SyncWidth, HSyncWidth.V0BackPorch, HBackPorch.VSyncPolarity) ;
	XVtc_SetGeneratorTiming(&vtc, &vtc_timing);
	XVtc_Enable(&vtc);
	XVtc_EnableGenerator(&vtc);
	XVtc_RegUpdateEnable(&vtc);

}
void ConfigTpg(XVidC_VideoStream *StreamPtr) {
	XV_tpg_DisableAutoRestart(&tpg);
	XV_tpg_Set_height(&tpg, StreamPtr->Timing.VActive); // 1080
	XV_tpg_Set_width(&tpg, StreamPtr->Timing.HActive); // 1920
	XV_tpg_Set_colorFormat(&tpg, XVIDC_CSF_RGB); // RGB
	XV_tpg_Set_bckgndId(&tpg, XTPG_BKGND_COLOR_BARS); // color bar
	XV_tpg_Set_ovrlayId(&tpg, 1); // moving box
	XV_tpg_Set_boxSize(&tpg, 100); // 100x100
	XV_tpg_Set_motionSpeed(&tpg, 10);
	XV_tpg_EnableAutoRestart(&tpg);
	XV_tpg_Start(&tpg);
}
int main() {
	init_platform();
	print("---------------------------------\n\r");
	print("----------KV260 TPG-----------\n\r");
	print("---------------------------------\n\r");

	XVidC_VideoTiming const *TimingPtr;
	XVidC_VideoMode TestModes = XVIDC_VM_1080_60_P ;
	XVidC_VideoStream VidStream;

	/*Set stream parameters*/
	VidStream.PixPerClk = tpg.Config.PixPerClk;
	VidStream.ColorFormatId = XVIDC_CSF_RGB; // RGB
	VidStream.ColorDepth = tpg.Config.MaxDataWidth;
	VidStream.VmId = TestModes ;
	TimingPtr = XVidC_GetTimingInfo(VidStream.VmId);
	VidStream.Timing = *TimingPtr;
	VidStream.FrameRate = XVidC_GetFrameRate(VidStream.VmId); // 1080p

	xil_printf("\r\n********************************************\r\n");
	xil_printf("Test Input Stream: %s (%s)\r\n",
			XVidC_GetVideoModeStr(VidStream.VmId),
			XVidC_GetColorFormatStr(VidStream.ColorFormatId));
	xil_printf("********************************************\r\n");

	driverInit();

	ConfigTpg(&VidStream);

	ConfigVtc(&VidStream);

	run_dppsu();

	cleanup_platform();
	return 0;
}
